<!DOCTYPE html>
<html>
<head>
<title>Camera Share (Sender + Receiver)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: Arial;
        background: #f2f2f2;
        padding: 20px;
    }
    .box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        max-width: 450px;
        margin: auto;
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }
    button {
        width: 100%;
        padding: 12px;
        background: #006EFF;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }
    video {
        width: 100%;
        background: black;
        border-radius: 10px;
        margin-top: 10px;
    }
</style>
</head>
<body>

<!-- SENDER -->
<div class="box">
    <h2>Sender — Share Camera</h2>
    <input id="sendCode" placeholder="Enter code (ex: ABC123)">
    <button onclick="senderConnect()">Start Sharing</button>
    <video id="localVideo" autoplay playsinline muted></video>
</div>

<!-- RECEIVER -->
<div class="box">
    <h2>Receiver — View Camera</h2>
    <input id="recvCode" placeholder="Enter code (ex: ABC123)">
    <button onclick="receiverConnect()">Connect</button>
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<script type="module">

/* --------------------------
      FIREBASE SETUP
--------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
    getFirestore, doc, setDoc, updateDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6C0obBf1DhLGqeslZervMQhYTAnhJNz0",
  authDomain: "camera-a8909.firebaseapp.com",
  databaseURL: "https://camera-a8909-default-rtdb.firebaseio.com",
  projectId: "camera-a8909",
  storageBucket: "camera-a8909.firebasestorage.app",
  messagingSenderId: "684343813628",
  appId: "1:684343813628:web:218292a6173fbe9c1dfe79",
  measurementId: "G-LDDDKW79JY"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* --------------------------
      SENDER (Camera)
--------------------------- */
const pcSend = new RTCPeerConnection();
const localVideo = document.getElementById("localVideo");

// Auto-start camera
navigator.mediaDevices.getUserMedia({ video: true, audio: false })
.then(stream => {
    localVideo.srcObject = stream;
    stream.getTracks().forEach(t => pcSend.addTrack(t, stream));
});

/* --------------------------
       RECEIVER
--------------------------- */
const pcRecv = new RTCPeerConnection();
const remoteVideo = document.getElementById("remoteVideo");

pcRecv.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
};

/* --------------------------
       SENDER CONNECT
--------------------------- */
async function senderConnect() {

    const code = document.getElementById("sendCode").value;
    const callRef = doc(db, "calls", code);

    const offer = await pcSend.createOffer();
    await pcSend.setLocalDescription(offer);

    await setDoc(callRef, { offer });

    // Wait for answer
    onSnapshot(callRef, async snap => {
        const data = snap.data();
        if (data?.answer && !pcSend.currentRemoteDescription) {
            await pcSend.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });
}

/* --------------------------
       RECEIVER CONNECT
--------------------------- */
async function receiverConnect() {

    const code = document.getElementById("recvCode").value;
    const callRef = doc(db, "calls", code);

    // Receive offer → send answer
    onSnapshot(callRef, async snap => {
        const data = snap.data();

        if (data?.offer && !pcRecv.currentRemoteDescription) {

            await pcRecv.setRemoteDescription(new RTCSessionDescription(data.offer));

            const answer = await pcRecv.createAnswer();
            await pcRecv.setLocalDescription(answer);

            await updateDoc(callRef, { answer });
        }
    });
}

</script>

</body>
</html>
