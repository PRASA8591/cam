<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Camera Connect â€” Fixed Modal Behavior</title>
<style>
  :root{
    --bg:#07101a; --card:#0f1724; --muted:#9aa3b2; --accent:#00b2ff; --accent2:#7c5cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#07101a,#0b1220);color:#e6eef8;min-height:100vh}
  .wrap{max-width:980px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#031025}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px;margin-top:14px}
  .center{text-align:center}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:inline-flex;gap:8px;align-items:center;color:#d6e2f5}
  input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#e6eef8}
  button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:10px 14px;border-radius:10px;color:#041028;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .big{padding:12px 18px;font-size:15px}
  video{width:100%;height:auto;background:#000;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:block;margin-top:10px}
  .code{font-family:ui-monospace,Menlo,monospace;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:#bfe8ff;display:inline-block}
  .muted{color:var(--muted);font-size:13px}
  .status{font-size:13px;color:#9ff8c9;margin-top:8px}
  .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

  /* minimal dark modal (Option A) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#0b1220;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);max-width:420px;width:92%}
  .modal h3{margin:0 0 8px;font-size:18px}
  .modal p{color:var(--muted);margin:8px 0 14px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  .btn-accept{background:#2e7d32;color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-reject{background:#c62828;color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}

  /* helper hidden class */
  .hidden{display:none !important}
  @media(max-width:820px){ .row{flex-direction:column;align-items:stretch} .logo{width:44px;height:44px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">CC</div>
      <div>
        <h1>Camera Connect</h1>
        <div class="subtitle">Choose Send or Receive â€” share mobile camera to any device using a short code.</div>
      </div>
    </header>

    <div class="card center">
      <div class="row" style="justify-content:center">
        <button id="chooseSend" class="big">ðŸ“¤ Send</button>
        <button id="chooseRecv" class="big">ðŸ“¥ Receive</button>
      </div>
    </div>

    <!-- SEND UI -->
    <div id="sendPanel" class="card hidden" aria-hidden="true">
      <h3 style="margin:0 0 8px">Sender â€” Share your camera</h3>
      <div class="row">
        <label><input id="optVideo" type="checkbox" checked> Camera</label>
        <label><input id="optAudio" type="checkbox" checked> Microphone</label>
        <div style="flex:1"></div>
        <button id="shareBtn" class="big">Share</button>
        <button id="disconnectBtn" class="ghost hidden">Disconnect</button>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Session code (share this with viewers):</div>
        <div id="sessionCode" class="code" style="margin-top:8px">â€”</div>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Local preview:</div>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>

      <div id="sendStatus" class="status hidden"></div>
    </div>

    <!-- RECEIVE UI -->
    <div id="recvPanel" class="card hidden" aria-hidden="true">
      <h3 style="margin:0 0 8px">Receiver â€” View remote camera</h3>
      <div class="row">
        <input id="codeInput" type="text" placeholder="Enter session code (e.g. AB12CD)">
        <div style="flex:1"></div>
        <button id="connectBtn" class="big">Connect</button>
        <button id="leaveBtn" class="ghost hidden">Disconnect</button>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Remote stream:</div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>

      <div id="recvStatus" class="status hidden"></div>
    </div>

    <footer>Host this page over HTTPS (GitHub Pages ok) or test on <code>http://localhost</code>. Make sure Firestore rules allow read/write during testing.</footer>
  </div>

  <!-- minimal dark confirmation modal - HIDDEN by default -->
  <div id="confirmModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Share your camera</h3>
      <p>Do you want to share your camera and/or microphone with anyone who has the session code? You can stop sharing by clicking Disconnect.</p>
      <div class="actions">
        <button id="confirmCancel" class="btn-reject">Cancel</button>
        <button id="confirmOk" class="btn-accept">Confirm Share</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
  // -------------------- FIREBASE CONFIG (your config) --------------------
  const firebaseConfig = {
    apiKey: "AIzaSyA6C0obBf1DhLGqeslZervMQhYTAnhJNz0",
    authDomain: "camera-a8909.firebaseapp.com",
    databaseURL: "https://camera-a8909-default-rtdb.firebaseio.com",
    projectId: "camera-a8909",
    storageBucket: "camera-a8909.firebasestorage.app",
    messagingSenderId: "684343813628",
    appId: "1:684343813628:web:218292a6173fbe9c1dfe79",
    measurementId: "G-LDDDKW79JY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  // ----------------------------------------------------------------------

  // UI refs
  const chooseSend = document.getElementById('chooseSend');
  const chooseRecv = document.getElementById('chooseRecv');
  const sendPanel = document.getElementById('sendPanel');
  const recvPanel = document.getElementById('recvPanel');

  const optVideo = document.getElementById('optVideo');
  const optAudio = document.getElementById('optAudio');
  const shareBtn = document.getElementById('shareBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const sessionCodeEl = document.getElementById('sessionCode');
  const localVideo = document.getElementById('localVideo');
  const sendStatus = document.getElementById('sendStatus');

  const codeInput = document.getElementById('codeInput');
  const connectBtn = document.getElementById('connectBtn');
  const leaveBtn = document.getElementById('leaveBtn');
  const remoteVideo = document.getElementById('remoteVideo');
  const recvStatus = document.getElementById('recvStatus');

  const confirmModal = document.getElementById('confirmModal');
  const confirmOk = document.getElementById('confirmOk');
  const confirmCancel = document.getElementById('confirmCancel');

  // state
  let localStream = null;
  let pc = null;
  let sessionRef = null;
  let senderCandidatesUnsub = null;
  let receiverCandidatesUnsub = null;
  let sessionSnapUnsub = null;

  const rtcConfig = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  };

  function show(el){ el.classList.remove('hidden'); el.removeAttribute('aria-hidden'); }
  function hide(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

  function makeCode(len=6){
    const ch = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
    let s=''; for(let i=0;i<len;i++) s += ch[Math.floor(Math.random()*ch.length)];
    return s;
  }

  // initial mode
  chooseSend.addEventListener('click', () => { show(sendPanel); hide(recvPanel); });
  chooseRecv.addEventListener('click', () => { show(recvPanel); hide(sendPanel); });

  // show modal ONLY when Share clicked
  shareBtn.addEventListener('click', () => {
    // modal appears only on explicit Share click
    show(confirmModal);
  });

  confirmCancel.addEventListener('click', () => hide(confirmModal));

  confirmOk.addEventListener('click', async () => {
    hide(confirmModal);
    await startSharing();
  });

  // START SHARING (runs only after user confirmed)
  async function startSharing(){
    shareBtn.disabled = true;
    sendStatus.textContent = 'Starting â€” allow camera/mic when prompted.';
    show(sendStatus);

    const useVideo = optVideo.checked;
    const useAudio = optAudio.checked;

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio });
      localVideo.srcObject = localStream;
    } catch (err) {
      alert('Could not access camera/microphone: ' + err);
      shareBtn.disabled = false;
      hide(sendStatus);
      return;
    }

    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    // create doc
    const code = makeCode(6);
    sessionCodeEl.textContent = code;
    sessionRef = db.collection('sessions').doc(code);

    const senderCandidates = sessionRef.collection('senderCandidates');
    const receiverCandidates = sessionRef.collection('receiverCandidates');

    pc.onicecandidate = event => {
      if (event.candidate) senderCandidates.add(event.candidate.toJSON()).catch(console.warn);
    };

    pc.ontrack = e => { console.log('sender got remote track', e.streams); };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const offerData = { type: offer.type, sdp: offer.sdp, createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'waiting' };
    await sessionRef.set({ offer: offerData, status:'waiting' }, { merge: true });

    // listen for receiverCandidates
    receiverCandidatesUnsub = receiverCandidates.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const cand = change.doc.data();
          pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e => console.warn('addIceCandidate failed', e));
        }
      });
    });

    // listen for answer
    sessionSnapUnsub = sessionRef.onSnapshot(async snap => {
      const data = snap.data();
      if (!data) return;
      if (data.answer && data.answer.sdp && pc && !pc.currentRemoteDescription) {
        try {
          const answerDesc = new RTCSessionDescription({ type: data.answer.type, sdp: data.answer.sdp });
          await pc.setRemoteDescription(answerDesc);
          sendStatus.textContent = 'Viewer connected â€” streaming.';
        } catch (err) {
          console.error('setRemoteDescription error', err);
          sendStatus.textContent = 'Error applying answer: ' + err;
        }
      }
    });

    // UI
    disconnectBtn.classList.remove('hidden');
    sendStatus.textContent = 'Session ready. Code: ' + code;
  }

  // disconnect sender & optionally delete doc
  disconnectBtn.addEventListener('click', async () => {
    await stopSharing(true);
  });

  async function stopSharing(deleteDoc=false){
    try {
      if (receiverCandidatesUnsub) { receiverCandidatesUnsub(); receiverCandidatesUnsub = null; }
      if (senderCandidatesUnsub) { senderCandidatesUnsub(); senderCandidatesUnsub = null; }
      if (sessionSnapUnsub) { sessionSnapUnsub(); sessionSnapUnsub = null; }
    } catch(e){ console.warn(e); }

    if (pc) { try { pc.getSenders().forEach(s => s.track && s.track.stop()); } catch(e){} try{ pc.close(); } catch(e){} pc = null; }
    if (localStream) { try { localStream.getTracks().forEach(t => t.stop()); } catch(e){} localStream = null; localVideo.srcObject = null; }

    if (sessionRef && deleteDoc) {
      try { await sessionRef.delete(); } catch(e){ console.warn('delete failed', e); }
    }

    // reset UI
    shareBtn.disabled = false;
    disconnectBtn.classList.add('hidden');
    sessionCodeEl.textContent = 'â€”';
    hide(sendStatus);
    sessionRef = null;
  }

  // RECEIVER connect
  connectBtn.addEventListener('click', async () => {
    const code = (codeInput.value || '').trim().toUpperCase();
    if (!code) { alert('Enter session code'); return; }
    connectBtn.disabled = true;
    recvStatus.textContent = 'Connectingâ€¦';
    show(recvStatus);

    try {
      sessionRef = db.collection('sessions').doc(code);
      const snap = await sessionRef.get();
      if (!snap.exists) {
        alert('Session not found: ' + code);
        hide(recvStatus);
        connectBtn.disabled = false;
        sessionRef = null;
        return;
      }

      const data = snap.data();
      if (!data.offer) {
        alert('Sender has not created an offer yet.');
        hide(recvStatus);
        connectBtn.disabled = false;
        sessionRef = null;
        return;
      }

      pc = new RTCPeerConnection(rtcConfig);

      pc.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
        recvStatus.textContent = 'Streaming.';
      };

      const receiverCandidates = sessionRef.collection('receiverCandidates');
      const senderCandidates = sessionRef.collection('senderCandidates');

      pc.onicecandidate = event => {
        if (event.candidate) receiverCandidates.add(event.candidate.toJSON()).catch(console.warn);
      };

      // subscribe to sender candidates
      senderCandidatesUnsub = senderCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
          if (change.type === 'added') {
            const cand = change.doc.data();
            try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch(e){ console.warn('addIce failed', e); }
          }
        });
      });

      // set remote description from offer
      const offer = data.offer;
      await pc.setRemoteDescription(new RTCSessionDescription({ type: offer.type, sdp: offer.sdp }));

      // create answer and save
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      const answerData = { type: answer.type, sdp: answer.sdp, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      await sessionRef.set({ answer: answerData, status: 'answered' }, { merge: true });

      recvStatus.textContent = 'Answer sent. Waiting for media...';
      leaveBtn.classList.remove('hidden');

    } catch (err) {
      console.error('Error connecting to session', err);
      alert('Error connecting: ' + err);
      hide(recvStatus);
      connectBtn.disabled = false;
      sessionRef = null;
    }
  });

  // receiver disconnect
  leaveBtn.addEventListener('click', async () => {
    await stopReceiving();
  });

  async function stopReceiving(){
    try {
      if (senderCandidatesUnsub) { senderCandidatesUnsub(); senderCandidatesUnsub = null; }
      if (receiverCandidatesUnsub) { receiverCandidatesUnsub(); receiverCandidatesUnsub = null; }
    } catch(e){ console.warn(e); }

    if (pc) { try { pc.close(); } catch(e){} pc = null; }
    remoteVideo.srcObject = null;

    connectBtn.disabled = false;
    leaveBtn.classList.add('hidden');
    hide(recvStatus);
    sessionRef = null;
  }

  // page unload â€” do not delete session doc automatically (session persists until manual disconnect)
  window.addEventListener('beforeunload', async () => {
    try { if (pc) { pc.close(); } } catch(e){}
  });

  // ensure modal hidden on start (this fixes the issue you reported)
  hide(confirmModal);
  hide(sendPanel);
  hide(recvPanel);
  hide(sendStatus);
  hide(recvStatus);
  // user must click Send or Receive to reveal panels
  // share modal appears only after pressing Share
  // end of script
  </script>
</body>
</html>
