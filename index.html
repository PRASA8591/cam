<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast GRN Batch Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        /* Camera Container */
        .camera-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            max-height: 60vh;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Overlay Box */
        .scan-guide {
            position: absolute;
            top: 20%; left: 10%; right: 10%; bottom: 40%;
            border: 2px solid #0d6efd;
            box-shadow: 0 0 0 100vh rgba(0,0,0,0.5);
            border-radius: 4px;
            pointer-events: none;
        }
        .scan-guide::after {
            content: "Align Header (GRN/Supplier)";
            position: absolute;
            top: -25px; left: 0; width: 100%;
            text-align: center; color: white;
            font-size: 0.8rem; font-weight: bold;
        }

        /* Queue Badge */
        .queue-badge {
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
        }

        /* Table Styling */
        .table-processing { background-color: #fff3cd; }
        .table-success-row { background-color: #d1e7dd; }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div class="sticky-top bg-white shadow-sm pb-2">
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <div class="scan-guide"></div>
            <div id="queue-indicator" class="queue-badge">Processing: 0</div>
        </div>
        
        <div class="row g-2 p-2">
            <div class="col-8">
                <button id="snap-btn" class="btn btn-primary w-100 btn-lg fw-bold">
                    ðŸ“¸ SNAP & SCAN
                </button>
            </div>
            <div class="col-4">
                <button onclick="downloadExcel()" id="export-btn" class="btn btn-success w-100 btn-lg" disabled>
                    ðŸ“¥ Excel
                </button>
            </div>
        </div>
    </div>

    <div class="container mt-3 pb-5">
        <h6 class="text-muted text-uppercase small fw-bold">Scanned Documents (<span id="total-count">0</span>)</h6>
        
        <div class="table-responsive">
            <table class="table table-bordered table-sm small align-middle" id="results-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 25%">GRN No</th>
                        <th style="width: 40%">Supplier</th>
                        <th style="width: 30%">Invoice</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
        <div id="empty-state" class="text-center text-muted py-5">
            Ready to scan. Align document header and tap Snap.
        </div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    // --- Configuration ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const tableBody = document.getElementById('table-body');
    const queueIndicator = document.getElementById('queue-indicator');
    
    let processingQueue = []; // Holds images waiting for OCR
    let isWorkerBusy = false;
    let scanCount = 0;
    let finalData = []; // Stores the clean JSON for Excel
    let worker = null; // Tesseract worker instance

    // --- 1. Initialize Camera & OCR Engine ---
    async function init() {
        // A. Camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Camera Access Denied or Error. Please use HTTPS.");
        }

        // B. Pre-load Tesseract Worker (Speed Boost)
        worker = await Tesseract.createWorker('eng');
        console.log("OCR Engine Ready");
    }
    init();

    // --- 2. Snap Button Logic (Fast Capture) ---
    document.getElementById('snap-btn').addEventListener('click', () => {
        scanCount++;
        
        // 1. Capture Image Frame Instantly
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imgData = canvas.toDataURL('image/png');

        // 2. Add "Processing" Row to Table immediately
        addPlaceholderRow(scanCount);
        
        // 3. Add to Queue
        processingQueue.push({ id: scanCount, image: imgData });
        updateQueueUI();

        // 4. Trigger Processor
        processQueue();
    });

    // --- 3. Queue Processor (Background Logic) ---
    async function processQueue() {
        if (isWorkerBusy || processingQueue.length === 0) return;

        isWorkerBusy = true;
        const currentTask = processingQueue.shift(); // Get oldest image
        updateQueueUI();

        try {
            // Run OCR
            const ret = await worker.recognize(currentTask.image);
            const text = ret.data.text;
            
            // Extract Data
            const extracted = parseText(text);
            
            // Update Table & Data Array
            updateRow(currentTask.id, extracted);
            
            // Add to final dataset if valid (optional: save even if empty)
            finalData.push({
                ID: currentTask.id,
                ...extracted,
                RawText: text.replace(/\n/g, " ").substring(0, 50) + "..." // Audit trail
            });

            document.getElementById('export-btn').disabled = false;

        } catch (err) {
            console.error(err);
            markRowError(currentTask.id);
        }

        isWorkerBusy = false;
        // Recursively call next item
        processQueue(); 
    }

    // --- 4. Regex Parsing (tuned for your document) ---
    function parseText(text) {
        // Clean text common OCR errors for printed docs
        text = text.replace(/\|/g, "I").replace(/l/g, "1").replace(/O/g, "0"); 
        
        // A. GRN Number (Matches: GRN No : GRN000...)
        // Pattern: Look for GRN, then optional No, then specific code format
        const grnMatch = text.match(/GRN\s*(?:No|Number)[\s:.]*([A-Z0-9]{8,})/i);
        
        // B. Supplier Name (Matches: Supplier Name : D.N.K...)
        // Pattern: specific "Supplier Name" keyword -> capture until newline
        const supMatch = text.match(/Supplier\s*Name[\s:.]*([^\n\r]+)/i);
        
        // C. Invoice No (Matches: GRN Invoice No : 3412...)
        const invMatch = text.match(/Invoice\s*No[\s:.]*([A-Z0-9]+)/i);

        return {
            grn: grnMatch ? grnMatch[1].trim() : "Not Found",
            supplier: supMatch ? supMatch[1].replace(/_/g, "").trim() : "Not Found",
            invoice: invMatch ? invMatch[1].trim() : "Not Found"
        };
    }

    // --- 5. UI Helpers ---
    function addPlaceholderRow(id) {
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('total-count').innerText = scanCount;

        const row = document.createElement('tr');
        row.id = `row-${id}`;
        row.className = "table-processing";
        row.innerHTML = `
            <td>${id}</td>
            <td colspan="3" class="text-center text-muted">
                <div class="spinner-border spinner-border-sm" role="status"></div> Analyzing...
            </td>
        `;
        // Insert at top
        tableBody.insertBefore(row, tableBody.firstChild);
    }

    function updateRow(id, data) {
        const row = document.getElementById(`row-${id}`);
        if(row) {
            row.className = ""; // Remove processing class
            row.innerHTML = `
                <td>${id}</td>
                <td class="fw-bold text-primary">${data.grn}</td>
                <td>${data.supplier}</td>
                <td>${data.invoice}</td>
            `;
        }
    }

    function markRowError(id) {
        const row = document.getElementById(`row-${id}`);
        if(row) {
            row.className = "table-danger";
            row.innerHTML = `<td>${id}</td><td colspan="3">Scan Failed</td>`;
        }
    }

    function updateQueueUI() {
        if(processingQueue.length > 0) {
            queueIndicator.style.display = 'block';
            queueIndicator.innerText = `Processing Queue: ${processingQueue.length}`;
        } else {
            queueIndicator.style.display = 'none';
        }
    }

    // --- 6. Export ---
    function downloadExcel() {
        const ws = XLSX.utils.json_to_sheet(finalData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "GRN_Data");
        XLSX.writeFile(wb, "Batch_Scan_Result.xlsx");
    }
</script>

</body>
</html>
